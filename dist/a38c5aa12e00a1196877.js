function _createForOfIteratorHelper(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var o=0,a=function(){};return{s:a,n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,i=!0,r=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){r=!0,s=e},f:function(){try{i||null==n.return||n.return()}finally{if(r)throw s}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=new Array(t);n<t;n++)o[n]=e[n];return o}var mailboxItem,mailbox;function action(e){var t={type:Office.MailboxEnums.ItemNotificationMessageType.InformationalMessage,message:"Performed action.",icon:"Icon.80x80",persistent:!0};Office.context.mailbox.item.notificationMessages.replaceAsync("action",t),e.completed()}Office.onReady((function(e){mailboxItem=Office.context.mailbox.item,mailbox=Office.context.mailbox,console.log("Office.js is now ready in ".concat(e.host," on ").concat(e.platform))}));var g=getGlobal();function getGlobal(){return"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:void 0}function actionMarkGreen(e){var t={type:Office.MailboxEnums.ItemNotificationMessageType.InformationalMessage,message:"Marked message green",icon:"IconGreen.80x80",persistent:!1},n={type:Office.MailboxEnums.ItemNotificationMessageType.InformationalMessage,message:"Failed to mark message green",icon:"IconGreen.80x80",persistent:!0};setSubjectPrefix("[Classified Green ðŸŸ¢]",(function(o){o?Office.context.mailbox.item.notificationMessages.replaceAsync("action",t):Office.context.mailbox.item.notificationMessages.replaceAsync("action",n),e.completed()}))}function actionMarkAmber(e){var t={type:Office.MailboxEnums.ItemNotificationMessageType.InformationalMessage,message:"Marked message amber",icon:"IconAmber.80x80",persistent:!1},n={type:Office.MailboxEnums.ItemNotificationMessageType.InformationalMessage,message:"Failed to mark message amber",icon:"IconAmber.80x80",persistent:!0};setSubjectPrefix("[Classified Amber ðŸŸ ]",(function(o){o?Office.context.mailbox.item.notificationMessages.replaceAsync("action",t):Office.context.mailbox.item.notificationMessages.replaceAsync("action",n),e.completed()}))}function actionMarkRed(e){var t={type:Office.MailboxEnums.ItemNotificationMessageType.InformationalMessage,message:"Marked message red",icon:"IconRed.80x80",persistent:!1},n={type:Office.MailboxEnums.ItemNotificationMessageType.InformationalMessage,message:"Failed to mark message red",icon:"IconRed.80x80",persistent:!0};setSubjectPrefix("[Classified Red ðŸ”´]",(function(o){o?Office.context.mailbox.item.notificationMessages.replaceAsync("action",t):Office.context.mailbox.item.notificationMessages.replaceAsync("action",n),e.completed()}))}g.action=action,g.actionMarkGreen=actionMarkGreen,g.actionMarkAmber=actionMarkAmber,g.actionMarkRed=actionMarkRed,g.validateBody=validateBody;var classifications={green:{subject:"[Classified Green ðŸŸ¢]"},amber:{subject:"[Classified Amber ðŸŸ ]"},red:{subject:"[Classified Red ðŸ”´]"}},regexp=/^(?:[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]?re:[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]?|[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]?awr:[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]?)*[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]?\[classified (red|green|amber) (?:[\0-\/:-@\[-\^`\{-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])\](?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*/;function checkSubjectClassified(e){if(e=e.toLowerCase(),regexp.test(e)){console.log("Getting matches for "+e);var t=e.match(regexp);return classifications[t[1]]}return!1}function setSubjectPrefix(e,t){findConversationSubjects(mailboxItem.conversationId,(function(n){var o,a=!1,s="",i=_createForOfIteratorHelper(n);try{for(i.s();!(o=i.n()).done;){value=o.value;var r=checkSubjectClassified(value);if(r){a=!0,s=r;break}}}catch(e){i.e(e)}finally{i.f()}mailboxItem.subject.getAsync((function(n){if(n.status==Office.AsyncResultStatus.Failed)console.log(n.error.message),t(!1);else{var o=checkSubjectClassified(n.value);if(o)return a&&o.subject===s.subject&&s.subject===e?void t(!0):void t(!1);a&&(e=s.subject),subject=e+" "+n.value,mailboxItem.subject.setAsync(subject,null,(function(e){e.status==Office.AsyncResultStatus.Failed?(console.log(e.error.message),t(!1)):t(!0)}))}}))}),(function(e){t(!1)}))}function validateBody(e){mailboxItem.body.getAsync("html",{asyncContext:e},checkBodyOnlyOnSendCallBack)}function validateSubjectAndCC(e){shouldChangeSubjectOnSend(e)}function shouldChangeSubjectOnSend(e){mailboxItem.subject.getAsync({asyncContext:e},(function(e){addCCOnSend(e.asyncContext);var t=new RegExp(/\[Checked\]/).test(e.value);subject="[Checked]: "+e.value,null===e.value||/^\s*$/.test(e.value)?(mailboxItem.notificationMessages.addAsync("NoSend",{type:"errorMessage",message:"Please enter a subject for this email."}),e.asyncContext.completed({allowEvent:!1})):t?e.asyncContext.completed({allowEvent:!0}):subjectOnSendChange(subject,e.asyncContext)}))}function addCCOnSend(e){mailboxItem.cc.setAsync(["Contoso@contoso.onmicrosoft.com"],{asyncContext:e})}function subjectOnSendChange(e,t){mailboxItem.subject.setAsync(e,{asyncContext:t},(function(e){e.status==Office.AsyncResultStatus.Failed?(mailboxItem.notificationMessages.addAsync("NoSend",{type:"errorMessage",message:"Unable to set the subject."}),e.asyncContext.completed({allowEvent:!1})):e.asyncContext.completed({allowEvent:!0})}))}function checkBodyOnlyOnSendCallBack(e){var t=new Array("blockedword","blockedword1","blockedword2").join("|");new RegExp("\\b("+t+")\\b","i").test(e.value)?(mailboxItem.notificationMessages.addAsync("NoSend",{type:"errorMessage",message:"Blocked words have been found in the body of this email. Please remove them."}),e.asyncContext.completed({allowEvent:!1})):e.asyncContext.completed({allowEvent:!0})}function asyncEws(e,t,n){console.log("Starting call"),mailbox.makeEwsRequestAsync(e,(function(e){if(console.log("Returning from call"),e.status===Office.AsyncResultStatus.Succeeded){console.log("makeEwsRequestAsync success. "+e.status);var o=(new DOMParser).parseFromString(e.value,"text/xml");t(o)}else console.log("makeEwsRequestAsync failed. "+e.error),n(e.error)}))}function getNodes(e,t){var n=t.substring(t.indexOf(":")+1),o=e.getElementsByTagName(t);return null!=o&&0!=o.length||(o=e.getElementsByTagName(n)),o}function getSoapHeader(e){return'<?xml version="1.0" encoding="utf-8"?><soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"               xmlns:xsd="http://www.w3.org/2001/XMLSchema"               xmlns:m="http://schemas.microsoft.com/exchange/services/2006/messages"               xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"               xmlns:t="http://schemas.microsoft.com/exchange/services/2006/types">   <soap:Header>       <RequestServerVersion Version="Exchange2013" xmlns="http://schemas.microsoft.com/exchange/services/2006/types" soap:mustUnderstand="0" />   </soap:Header>   <soap:Body>'+e+"</soap:Body></soap:Envelope>"}function findConversationSubjects(e,t,n){var o='       <m:GetConversationItems>           <m:ItemShape>               <t:BaseShape>IdOnly</t:BaseShape>               <t:AdditionalProperties>                   <t:FieldURI FieldURI="item:Subject" />                   <t:FieldURI FieldURI="item:DateTimeReceived" />               </t:AdditionalProperties>           </m:ItemShape>           <m:FoldersToIgnore>               <t:DistinguishedFolderId Id="deleteditems" />               <t:DistinguishedFolderId Id="drafts" />           </m:FoldersToIgnore>           <m:SortOrder>TreeOrderDescending</m:SortOrder>           <m:Conversations>               <t:Conversation>                   <t:ConversationId Id="'+e+'" />               </t:Conversation>           </m:Conversations>       </m:GetConversationItems>';o=getSoapHeader(o),console.log("got soap header"),asyncEws(o,(function(e){var n,o=[],a=_createForOfIteratorHelper(getNodes(e,"t:Subject"));try{for(a.s();!(n=a.n()).done;)msg=n.value,o.push(msg.textContent)}catch(e){a.e(e)}finally{a.f()}t(o)}),(function(e){null!=n&&n(e)}))}