function _createForOfIteratorHelper(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0,o=function(){};return{s:o,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,i=!0,r=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){r=!0,s=e},f:function(){try{i||null==n.return||n.return()}finally{if(r)throw s}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=new Array(t);n<t;n++)a[n]=e[n];return a}var mailboxItem,mailbox,g=getGlobal();function getGlobal(){return"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:void 0}Office.onReady((function(e){for(var t in mailboxItem=Office.context.mailbox.item,mailbox=Office.context.mailbox,classifications){var n=classifications[t];g[n.globalFunction]=actionMarkFactory(n)}console.log("Office.js is now ready in ".concat(e.host," on ").concat(e.platform))})),g.validateBody=validateBody;var classifications={white:{name:"TLP White",globalFunction:"actionMarkWhite",subject:"[Classified White âšª]",icon80:"Icon.80x80"},green:{name:"TLP Green",globalFunction:"actionMarkGreen",subject:"[Classified Green ðŸŸ¢]",icon80:"IconGreen.80x80"},amber:{name:"TLP Amber",globalFunction:"actionMarkAmber",subject:"[Classified Amber ðŸŸ ]",icon80:"IconOrange.80x80"},red:{name:"TLP Red",globalFunction:"actionMarkRed",subject:"[Classified Red ðŸ”´]",icon80:"IconRed.80x80"}},classifierRegexp=/[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*\[cla[s\u017F][s\u017F]ified (white|green|amber|red) (?:[\0-\/:-@\[-\^`\{-\u017E\u0180-\u2129\u212B-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])\][\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*/gi,classifiedSubjectRegexp=/^(?:[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]?re:[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]?|[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]?aw:[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]?)*[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*\[cla[s\u017F][s\u017F]ified (white|green|amber|red) (?:[\0-\/:-@\[-\^`\{-\u017E\u0180-\u2129\u212B-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])\](?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*/i;function removeClassification(e){return e.replace(classifierRegexp," ").trim()}function addClassificationPrefix(e,t){return e?e.subject+" "+t:t}function getClassification(e){if(e=e.toLowerCase(),classifiedSubjectRegexp.test(e)){var t=e.match(classifiedSubjectRegexp);return classifications[t[1]]}return null}function normalizeClassification(e){var t=getClassification(e);return t?e=addClassificationPrefix(t,e=removeClassification(e)):e}function actionMarkFactory(e){return function(t){var n={type:Office.MailboxEnums.ItemNotificationMessageType.InformationalMessage,message:"Marked message "+e.name,icon:e.icon80,persistent:!1},a={type:Office.MailboxEnums.ItemNotificationMessageType.ErrorMessage,message:"Failed to mark message (requested "+e.name+")"};setSubjectPrefix(e,(function(e){e?Office.context.mailbox.item.notificationMessages.replaceAsync("action",n):Office.context.mailbox.item.notificationMessages.replaceAsync("action",a),t.completed()}))}}function setSubjectPrefix(e,t){findConversationSubjects(mailboxItem.conversationId,(function(n){var a,o=!1,s="",i=_createForOfIteratorHelper(n);try{for(i.s();!(a=i.n()).done;){value=a.value;var r=getClassification(value);if(r){o=!0,s=r;break}}}catch(e){i.e(e)}finally{i.f()}mailboxItem.subject.getAsync((function(n){if(n.status==Office.AsyncResultStatus.Failed)console.log(n.error.message),t(!1);else{var a=n.value,i=getClassification(a);if(i)if(o){if(i.subject!==s.subject||s.subject!==e.subject)return void t(!1);a=normalizeClassification(a)}else a=removeClassification(a),a=addClassificationPrefix(e,a);else a=addClassificationPrefix(o?s:e,a);mailboxItem.subject.setAsync(a,null,(function(e){e.status==Office.AsyncResultStatus.Failed?(console.log(e.error.message),t(!1)):t(!0)}))}}))}),(function(e){t(!1)}))}function validateBody(e){forceClassificationSubject(e)}function forceClassificationSubject(e){mailboxItem.subject.getAsync({asyncContext:e},(function(e){var t=e.value,n=getClassification(t);if(!n)return mailboxItem.notificationMessages.addAsync("NoSend",{type:"errorMessage",message:"Please choose a classification for this email."}),void e.asyncContext.completed({allowEvent:!1});Office.context.mailbox.item.saveAsync((function(a){setCategory(a.value,n.name,e.asyncContext,(function(e){subjectOnSendChange(t=normalizeClassification(t),e)}))}))}))}function subjectOnSendChange(e,t){mailboxItem.subject.setAsync(e,{asyncContext:t},(function(e){e.status==Office.AsyncResultStatus.Failed?(mailboxItem.notificationMessages.addAsync("NoSend",{type:"errorMessage",message:"Unable to set the subject."}),e.asyncContext.completed({allowEvent:!1})):e.asyncContext.completed({allowEvent:!0})}))}function asyncEws(e,t,n){mailbox.makeEwsRequestAsync(e,(function(e){if(e.status===Office.AsyncResultStatus.Succeeded){console.log("makeEwsRequestAsync success. "+e.status);var a=(new DOMParser).parseFromString(e.value,"text/xml");t(a)}else console.log("makeEwsRequestAsync failed. "+e.error),n(e.error)}))}function getNodes(e,t){var n=t.substring(t.indexOf(":")+1),a=e.getElementsByTagName(t);return null!=a&&0!=a.length||(a=e.getElementsByTagName(n)),a}function getSoapHeader(e){return'<?xml version="1.0" encoding="utf-8"?><soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"               xmlns:xsd="http://www.w3.org/2001/XMLSchema"               xmlns:m="http://schemas.microsoft.com/exchange/services/2006/messages"               xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"               xmlns:t="http://schemas.microsoft.com/exchange/services/2006/types">   <soap:Header>       <RequestServerVersion Version="Exchange2013" xmlns="http://schemas.microsoft.com/exchange/services/2006/types" soap:mustUnderstand="0" />   </soap:Header>   <soap:Body>'+e+"</soap:Body></soap:Envelope>"}function findConversationSubjects(e,t,n){e||t([]);var a='       <m:GetConversationItems>           <m:ItemShape>               <t:BaseShape>IdOnly</t:BaseShape>               <t:AdditionalProperties>                   <t:FieldURI FieldURI="item:Subject" />                   <t:FieldURI FieldURI="item:DateTimeReceived" />               </t:AdditionalProperties>           </m:ItemShape>           <m:FoldersToIgnore>               <t:DistinguishedFolderId Id="deleteditems" />               <t:DistinguishedFolderId Id="drafts" />           </m:FoldersToIgnore>           <m:SortOrder>TreeOrderDescending</m:SortOrder>           <m:Conversations>               <t:Conversation>                   <t:ConversationId Id="'+e+'" />               </t:Conversation>           </m:Conversations>       </m:GetConversationItems>';asyncEws(a=getSoapHeader(a),(function(e){var n,a=[],o=_createForOfIteratorHelper(getNodes(e,"t:Subject"));try{for(o.s();!(n=o.n()).done;){var s=n.value;a.push(s.textContent)}}catch(e){o.e(e)}finally{o.f()}t(a)}),(function(e){null!=n&&n(e)}))}function setCategory(e,t,n,a){if(!e)return console.log("Ignoring invalid itemId in setCategory: "+e),void a(n);asyncEws(getSoapHeader('<UpdateItem MessageDisposition="SaveOnly" ConflictResolution="AlwaysOverwrite" xmlns="http://schemas.microsoft.com/exchange/services/2006/messages">\n\t\t\t<ItemChanges>\n\t\t\t\t<t:ItemChange>\n\t\t\t\t\t<t:ItemId Id="'+e+'"/>\n\t\t\t\t\t<t:Updates>\n\t\t\t\t\t\t<t:SetItemField>\n\t\t\t\t\t\t\t<t:ExtendedFieldURI PropertySetId="00020329-0000-0000-C000-000000000046" PropertyName="Keywords" PropertyType="StringArray" />\n\t\t\t\t\t\t\t<t:Message>\n\t\t\t\t\t\t\t\t<t:ExtendedProperty>\n\t\t\t\t\t\t\t\t\t<t:ExtendedFieldURI PropertySetId="00020329-0000-0000-C000-000000000046" PropertyName="Keywords" PropertyType="StringArray" />\n\t\t\t\t\t\t\t\t\t<t:Values>\n\t\t\t\t\t\t\t\t\t\t<t:Value>'+t+"</t:Value>\n\t\t\t\t\t\t\t\t\t</t:Values>\n\t\t\t\t\t\t\t\t</t:ExtendedProperty>\n\t\t\t\t\t\t\t</t:Message>\n\t\t\t\t\t\t</t:SetItemField>\n\t\t\t\t\t</t:Updates>\n\t\t\t\t</t:ItemChange>\n\t\t\t</ItemChanges>\n\t\t</UpdateItem>"),(function(e){console.log("Successfully set category: "+e),a(n)}),(function(e){console.log("Error setting category: "+e),a(n)}))}